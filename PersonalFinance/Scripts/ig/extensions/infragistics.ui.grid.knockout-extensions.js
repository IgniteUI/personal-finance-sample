/*!@license
* Infragistics.Web.ClientUI igGrid KnockoutJS extension 13.2.20132.1010
*
* Copyright (c) 2011-2013 Infragistics Inc.
*
* http://www.infragistics.com/
*
* Depends on:
*	jquery-1.7.1.js
*	ig.util.js
*	ig.dataSource.js
*	ig.ui.grid.framework.js
*/
ko.bindingHandlers.igGrid={init:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var grid=$(element),gridObj=grid.data("igGrid"),binding,options,key,handler,g,o,d,renderNewRowKo,renderNewRowGrid;if(grid.attr("data-create")!=="false"){binding=ko.utils.unwrapObservable(valueAccessor());options={};options.dataSource=new $.ig.KnockoutDataSource({dataSource:binding.dataSource});for(key in binding){if(binding.hasOwnProperty(key)&&key!=="dataSource"){options[key]=binding[key]}}}else{binding=options=gridObj.options}renderNewRowKo=function(rec,key){renderNewRowGrid.apply(gridObj,[rec,key]);handler(null,{owner:gridObj})};handler=function(event,args){var ds,owner=args.owner.grid||args.owner,gridElement=owner.element,pageIndex=gridElement.data("igGridPaging")?gridElement.data("igGridPaging").pageIndex():0,pageSize=gridElement.data("igGridPaging")?gridElement.data("igGridPaging").pageSize():0,startRowIndex=pageIndex*pageSize,opts=owner.options;if(ko.isObservable(owner.dataSource.kods)){ds=owner.dataSource.kods()}else if(ko.isObservable(owner.dataSource.kods[owner.options.responseDataKey])){ds=owner.dataSource.kods[owner.options.responseDataKey]()}else{ds=owner.dataSource.dataSource()}grid.attr("data-bound",args.owner.grid?false:true);if(!opts.rowVirtualization&&!opts.virtualization){owner._startRowIndex=startRowIndex}owner.element.children("tbody").children("tr[data-grouprow!=true][data-container!=true]").filter(function(){return this.style.visibility!=="hidden"}).map(function(i){var tr_id=$(this).attr("data-id"),gridDataBound=grid.attr("data-bound"),restoreGridState=false,id,k,l,cells,dataVal,rec=ds.filter(function(item){id=item[owner.options.primaryKey];if(ko.isObservable(id)){id=id()}return String(id)===String(tr_id)});if(rec.length===0){grid.attr("data-bound",false);rec=ds[i+startRowIndex];restoreGridState=true}else{rec=rec[0]}if(rec){cells=$(this).children("td[data-parent!=true][data-parent!=false][data-skip!=true]");l=0;for(k=0;k<opts.columns.length;k++){if(opts.columns[k].hidden){continue}dataVal=rec[opts.columns[k].key];if(ko.isObservable(dataVal)){ko.applyBindingsToNode(cells[l++],{igCell:{value:opts.columns[k]}},dataVal)}}}else{$(this).remove()}if(restoreGridState){grid.attr("data-bound",gridDataBound)}});grid.removeAttr("data-bound")};grid.bind("iggridrendering",function(evt,ui){gridObj=ui.owner;if(renderNewRowGrid!==gridObj.renderNewRow){renderNewRowGrid=gridObj.renderNewRow;gridObj.renderNewRow=renderNewRowKo}}).bind("iggriddatarendered",handler).bind("iggridvirtualrecordsrender",handler).bind("iggriduisoftdirty",handler).bind("iggridfilteringdatafiltered",handler).bind("iggridpagingpageindexchanged",handler);if(grid.attr("data-create")!=="false"){grid.igGrid(options)}else{g=grid.data("igGrid");o=g.options;d=g.dataSource.kods;if(o.responseDataKey&&d[o.responseDataKey]){d=d[o.responseDataKey]}d=ko.isObservable(d)?d():d;grid.attr("data-bound",true);grid.find("tbody").children("tr[data-grouprow!=true][data-container!=true]").map(function(i){$(this).children("[data-parent!=true][data-parent!=false][data-skip!=true]").map(function(j){var dataVal=d[i][o.columns[j].key];if(ko.isObservable(dataVal)){ko.applyBindingsToNode(this,{igCell:{value:o.columns[j]}},dataVal)}})});grid.removeAttr("data-bound")}return{controlsDescendantBindings:true}},update:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var grid=$(element).data("igGrid"),newds,oldds,updating=$(element).data("igGridUpdating")||$("#"+grid.id()).data("igGridUpdating"),i,key,changes,c,autoCommit=grid.options.autoCommit;newds=valueAccessor().dataSource;if(!newds){if(grid.options.responseDataKey){newds=grid.dataSource.kods[grid.options.responseDataKey]}else{newds=grid.dataSource.kods}}oldds=grid.dataSource._knockoutState;grid.dataSource._knockoutState=$.extend([],newds());if(!oldds){return}if(updating===null||updating===undefined){throw new Error("two-way adding and deleting of rows with KnockoutJS requires the Updating feature to be defined")}if(typeof newds==="function"&&!grid.dataSource._ownUpdate){changes=ko.utils.compareArrays(oldds,newds());for(i=0;i<changes.length;i++){c=changes[i];if(c.status==="deleted"){grid.dataSource._koUpdate=true;key=c.value[grid.options.primaryKey];key=ko.isObservable(key)?key():key;grid.options.autoCommit=true;updating.deleteRow(key);grid.options.autoCommit=autoCommit}else if(c.status==="added"){key=c.value[grid.options.primaryKey];key=ko.isObservable(key)?key():key;grid.dataSource._koUpdate=true;grid.options.autoCommit=true;updating.addRow(ko.mapping.toJS(c.value));grid.options.autoCommit=autoCommit}}}grid.dataSource._ownUpdate=false}};ko.visitPropertiesOrArrayEntries=function(rootObject,visitorCallback){var i,propertyName;if(rootObject instanceof Array){for(i=0;i<rootObject.length;i++){visitorCallback(i)}}else{for(propertyName in rootObject){if(rootObject.hasOwnProperty(propertyName)){visitorCallback(propertyName)}}}};ko.bindingHandlers.igHierarchicalGrid={init:function(element,valueAccessor,allBindingsAccessor,viewModel,bindingContext){var grid=$(element),binding,options,ds,opts,skip=0,td,childgridhandler,key;binding=ko.utils.unwrapObservable(valueAccessor());options={};ds=ko.isObservable(binding.dataSource)?binding.dataSource():binding.dataSource;if(ds instanceof $.ig.DataSource){ds=ds.data()}options.dataSource=new $.ig.KnockoutDataSource({dataSource:binding.dataSource});for(key in binding){if(binding.hasOwnProperty(key)&&key!=="dataSource"){options[key]=binding[key]}}grid.igHierarchicalGrid(options);grid.data("observableDataSource",options.dataSource);childgridhandler=function(event,args){var kods,opts=args.options,observableDs;if(args.element.data("igGrid")){return}kods=args.owner.element.data("observableDataSource");observableDs=kods.dataAt(args.id,args.path);opts.dataSource=new $.ig.KnockoutDataSource({primaryKey:opts.primaryKey,dataSource:opts.dataSource,observableDataSource:observableDs,responseDataKey:opts.responseDataKey});args.element.igGrid(opts);opts=args.element.data("igGrid").options;args.element.attr("data-create",false);ko.applyBindingsToNode(args.element[0],{igGrid:{}},observableDs)};grid.delegate("table","igchildgridcreating",childgridhandler);opts=grid.data("igGrid").options;grid.attr("data-bound",true);grid.children("tbody").children("tr").map(function(i){$(this).children().map(function(j){td=$(this);if(!td.attr("data-skip")&&!td.hasClass("ui-iggrid-expandcolumn")){ko.applyBindingsToNode(this,{igCell:{value:opts.columns[j-skip]}},ds[i][opts.columns[j-skip].key])}else{skip++}});skip=0});grid.removeAttr("data-bound");return{controlsDescendantBindings:true}},update:ko.bindingHandlers.igGrid.update};ko.bindingHandlers.igCell={update:function(element,valueAccessor,allBindingsAccessor,viewModel){var cell=$(element),tbl=cell.closest(".ui-iggrid-table"),grid=tbl.data("igGrid"),key,tmpldata={},newFormattedVal,tr,rec,keyVal,col;if(tbl.attr("data-bound")!=="true"){key=valueAccessor().value.key;if(grid.options.rowTemplate&&grid.options.rowTemplate.length>0){tmpldata[key]=viewModel;newFormattedVal=grid._renderTemplatedCell(tmpldata,valueAccessor().value).substring(1)}else{newFormattedVal=grid._renderCell(viewModel,valueAccessor().value)}cell.html(newFormattedVal);tr=cell.closest("tr");col=grid.columnByKey(grid.options.primaryKey);if(tr.attr("data-id")!==null&&tr.attr("data-id")!==undefined){if(col.dataType==="number"||col.dataType===undefined){keyVal=parseInt(tr.attr("data-id"),10);if(key===grid.options.primaryKey){viewModel=parseInt(viewModel,10)}}else{keyVal=tr.attr("data-id")}rec=grid.dataSource.findRecordByKey(keyVal);if(rec===null){rec=grid.dataSource.findRecordByKey(viewModel)}if(key===grid.options.primaryKey){tr.attr("data-id",viewModel);tr.data().id=viewModel}rec[key]=viewModel}else{throw new Error("Updating the data source requires a primary key to be defined")}}grid.dataSource._ownUpdate=false}};